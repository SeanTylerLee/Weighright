<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>WeighRight • Calculator</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="app">
  <!-- Header -->
  <header class="app-header">
    <button class="btn ghost" onclick="history.back()">Back</button>
    <h1 class="app-title">WeighRight Calculator</h1>
    <button id="resetBtn" class="btn ghost">Reset</button>
  </header>

  <main class="container">
    <!-- Presets -->
    <section class="card">
      <h2>Caps & Effects</h2>
      <div class="grid2">
        <div>
          <label>Legal Caps (lbs)</label>
          <div class="grid2">
            <input id="capSteer" type="number" inputmode="numeric" placeholder="Steer" value="12000">
            <input id="capDrives" type="number" inputmode="numeric" placeholder="Drives" value="34000">
          </div>
          <div class="grid2 mt8">
            <input id="capTrailer" type="number" inputmode="numeric" placeholder="Trailer" value="34000">
            <input id="capGross" type="number" inputmode="numeric" placeholder="Gross" value="80000">
          </div>
        </div>
        <div>
          <label>Per-Hole Effects (lbs)</label>
          <div class="grid2">
            <input id="lbsPerHoleTrailer" type="number" inputmode="numeric" placeholder="Trailer tandems" value="300">
            <input id="lbsPerHole5th" type="number" inputmode="numeric" placeholder="5th wheel" value="500">
          </div>
          <div class="grid2 mt8">
            <select id="trailerDir">
              <option value="toTrailer">Tandems BACK adds to trailer</option>
              <option value="toDrives">Tandems BACK adds to drives</option>
            </select>
            <select id="fifthDir">
              <option value="toSteer">5th FORWARD adds to steer</option>
              <option value="toDrives">5th FORWARD adds to drives</option>
            </select>
          </div>
        </div>
      </div>
      <div class="actions">
        <button id="savePresets" class="btn">Save Presets</button>
        <span class="muted small">Saved on this device.</span>
      </div>
    </section>

    <!-- Axle Adjustment Planner -->
    <section class="card">
      <h2>Axle Adjustment Planner</h2>
      <div class="grid3">
        <div>
          <label>Steer (current)</label>
          <input id="steerNow" type="number" inputmode="numeric" placeholder="e.g. 11800">
        </div>
        <div>
          <label>Drives (current)</label>
          <input id="drivesNow" type="number" inputmode="numeric" placeholder="e.g. 35200">
        </div>
        <div>
          <label>Trailer (current)</label>
          <input id="trailerNow" type="number" inputmode="numeric" placeholder="e.g. 33200">
        </div>
      </div>
      <div class="actions">
        <button id="calcAdjust" class="btn primary">Plan Adjustments</button>
        <button id="clearAdjust" class="btn ghost">Clear</button>
        <button id="quickLegal" class="btn ghost">Quick Legal</button>
        <button id="shareBtn" class="btn ghost">Share</button>
      </div>
      <pre id="adjustOut" class="result"></pre>
    </section>

    <!-- Bridge Formula -->
    <section class="card">
      <h2>Bridge Formula (Federal)</h2>
      <div class="grid2">
        <div>
          <label>Axles in group (N)</label>
          <input id="bfN" type="number" min="2" max="7" step="1" value="2">
        </div>
        <div>
          <label>Outer spacing L (feet)</label>
          <input id="bfL" type="number" step="0.1" placeholder="Distance between outer axles">
        </div>
      </div>
      <div class="grid2 mt8">
        <div>
          <label>Rounding</label>
          <select id="bfRound">
            <option value="nearest" selected>Nearest 500</option>
            <option value="down">Round down 500</option>
            <option value="none">No rounding</option>
          </select>
        </div>
        <div>
          <label>Apply 80,000 gross cap?</label>
          <select id="bfGrossCap">
            <option value="yes" selected>Yes</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="calcBridge" class="btn">Calculate</button>
        <button id="clearBridge" class="btn ghost">Clear</button>
      </div>
      <pre id="bridgeOut" class="result"></pre>
      <p class="muted small mt6">Formula: <code>F = 500 * [ (L·N)/(N-1) + 12N + 36 ]</code></p>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="tabbar">
    <a class="tab" href="index.html">Home</a>
    <a class="tab active" href="axlecalc.html">Calculator</a>
    <a class="tab" href="settings.html">Settings</a>
  </nav>

  <script>
    const $ = id => document.getElementById(id);
    const roundToNearest500 = v => Math.round(v/500)*500;
    const roundDownTo500 = v => Math.floor(v/500)*500;

    function loadPresets(){
      const p = JSON.parse(localStorage.getItem('axlePresets')||'{}');
      const map = {
        capSteer:12000, capDrives:34000, capTrailer:34000, capGross:80000,
        lbsPerHoleTrailer:300, lbsPerHole5th:500, trailerDir:'toTrailer', fifthDir:'toSteer'
      };
      for (const k in map) { if (p[k] != null) map[k]=p[k]; }
      for (const k in map) { $(k).value = map[k]; }
    }
    function savePresets(){
      const keys = ['capSteer','capDrives','capTrailer','capGross','lbsPerHoleTrailer','lbsPerHole5th','trailerDir','fifthDir'];
      const p = {}; keys.forEach(k => p[k] = (k.includes('Dir')? $(k).value : +$(k).value||0));
      localStorage.setItem('axlePresets', JSON.stringify(p));
      alert('Presets saved');
    }

    function planAdjustments(){
      const steer = +$('steerNow').value||0;
      const drives = +$('drivesNow').value||0;
      const trailer = +$('trailerNow').value||0;

      const capSteer = +$('capSteer').value||12000;
      const capDrives = +$('capDrives').value||34000;
      const capTrailer = +$('capTrailer').value||34000;
      const capGross = +$('capGross').value||80000;

      const lbsPerHoleT = Math.max(0, +$('lbsPerHoleTrailer').value||300);
      const lbsPerHole5 = Math.max(0, +$('lbsPerHole5th').value||500);

      const trailerDir = $('trailerDir').value;
      const fifthDir = $('fifthDir').value;

      const gross = steer + drives + trailer;
      let msg = [];
      msg.push(`Current: steer=${steer.toLocaleString()}  drives=${drives.toLocaleString()}  trailer=${trailer.toLocaleString()}  gross=${gross.toLocaleString()}`);

      let holesTrailer = 0, newDrives = drives, newTrailer = trailer;
      if(lbsPerHoleT > 0){
        if(drives > capDrives && trailer < capTrailer && trailerDir === 'toTrailer'){
          const need = drives - capDrives;
          const room = capTrailer - trailer;
          holesTrailer = Math.min(Math.ceil(need/lbsPerHoleT), Math.floor(room/lbsPerHoleT));
          newDrives -= holesTrailer*lbsPerHoleT;
          newTrailer += holesTrailer*lbsPerHoleT;
        } else if(trailer > capTrailer && drives < capDrives && trailerDir === 'toDrives'){
          const need = trailer - capTrailer;
          const room = capDrives - drives;
          holesTrailer = Math.min(Math.ceil(need/lbsPerHoleT), Math.floor(room/lbsPerHoleT));
          newDrives += holesTrailer*lbsPerHoleT;
          newTrailer -= holesTrailer*lbsPerHoleT;
        }
      }
      msg.push(holesTrailer>0
        ? `Trailer tandems: move ${holesTrailer} hole(s) BACK (${trailerDir==='toTrailer'?'adds to trailer':'adds to drives'}).`
        : `Trailer tandems: no change suggested.`);

      let holes5th = 0, newSteer = steer, adjDrives = newDrives;
      if(lbsPerHole5 > 0){
        if(newSteer > capSteer){
          holes5th = Math.ceil((newSteer - capSteer)/lbsPerHole5);
          newSteer -= holes5th*lbsPerHole5;
          adjDrives += holes5th*lbsPerHole5;
          msg.push(`5th wheel: move ${holes5th} hole(s) BACK (adds to drives) to reduce steer.`);
        } else if(adjDrives > capDrives && (capSteer - newSteer) > 0){
          const need = adjDrives - capDrives;
          const steerRoom = capSteer - newSteer;
          const holesByNeed = Math.ceil(need/lbsPerHole5);
          const holesByRoom = Math.floor(steerRoom/lbsPerHole5);
          holes5th = Math.min(holesByNeed, holesByRoom);
          if(holes5th>0){
            newSteer += holes5th*lbsPerHole5;
            adjDrives -= holes5th*lbsPerHole5;
            msg.push(`5th wheel: move ${holes5th} hole(s) FORWARD (adds to steer) to reduce drives.`);
          } else {
            msg.push(`5th wheel: no safe forward move (steer has no room).`);
          }
        } else {
          msg.push(`5th wheel: no change suggested.`);
        }
      }

      const finalSteer = newSteer;
      const finalDrives = adjDrives;
      const finalTrailer = newTrailer;
      const finalGross = finalSteer + finalDrives + finalTrailer;

      msg.push('');
      msg.push(`Projected: steer=${finalSteer.toLocaleString()}  drives=${finalDrives.toLocaleString()}  trailer=${finalTrailer.toLocaleString()}  gross=${finalGross.toLocaleString()}`);
      msg.push(`Room/Over (+: room, -: over): steer=${(capSteer-finalSteer).toLocaleString()}  drives=${(capDrives-finalDrives).toLocaleString()}  trailer=${(capTrailer-finalTrailer).toLocaleString()}  gross=${(capGross-finalGross).toLocaleString()}`);

      $('adjustOut').textContent = msg.join('\n');
    }

    function calcBridge(){
      const N = +$('bfN').value||0;
      const L = +$('bfL').value||0;
      if(N < 2 || L <= 0){ $('bridgeOut').textContent='Enter N≥2 and L>0.'; return; }
      let F = 500 * ( (L*N)/(N-1) + 12*N + 36 );
      const mode = $('bfRound').value;
      if(mode==='nearest') F = roundToNearest500(F);
      if(mode==='down')    F = roundDownTo500(F);
      const cap = $('bfGrossCap').value==='yes' ? (+$('capGross').value||80000) : Infinity;
      const Fcapped = Math.min(F, cap);
      const out = [
        `Inputs: N=${N}, L=${L} ft`,
        `Bridge limit (group): ${Math.round(F).toLocaleString()} lbs`,
        (isFinite(cap)&&F>cap) ? `Applied gross cap: ${cap.toLocaleString()} lbs` : null,
        `Allowed weight: ${Math.round(Fcapped).toLocaleString()} lbs`
      ].filter(Boolean).join('\n');
      $('bridgeOut').textContent = out;
    }

    function quickLegal(){
      const s=+$('steerNow').value||0,d=+$('drivesNow').value||0,t=+$('trailerNow').value||0,g=s+d+t;
      const cs=+$('capSteer').value||12000, cd=+$('capDrives').value||34000, ct=+$('capTrailer').value||34000, cg=+$('capGross').value||80000;
      alert(`Legal check:\nSteer ${s}/${cs} = ${s-cs}\nDrives ${d}/${cd} = ${d-cd}\nTrailer ${t}/${ct} = ${t-ct}\nGross ${g}/${cg} = ${g-cg}`);
    }
    async function shareData(){
      const text = `Axle Plan\n${$('adjustOut').textContent}\n\nBridge\n${$('bridgeOut').textContent}`;
      if(navigator.share){ try{ await navigator.share({title:'Axle Plan', text}); }catch(_){} }
      else { await navigator.clipboard.writeText(text); alert('Copied to clipboard'); }
    }

    $('savePresets').addEventListener('click', savePresets);
    $('calcAdjust').addEventListener('click', planAdjustments);
    $('clearAdjust').addEventListener('click', ()=>{$('adjustOut').textContent=''; ['steerNow','drivesNow','trailerNow'].forEach(id=>$(id).value='');});
    $('quickLegal').addEventListener('click', quickLegal);
    $('shareBtn').addEventListener('click', shareData);

    $('calcBridge').addEventListener('click', calcBridge);
    $('clearBridge').addEventListener('click', ()=>{$('bridgeOut').textContent=''; $('bfL').value='';});

    $('resetBtn').addEventListener('click', ()=>{ localStorage.removeItem('axlePresets'); location.reload(); });

    loadPresets();
  </script>
</body>
</html>